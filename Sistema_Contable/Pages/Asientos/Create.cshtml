@page
@model Sistema_Contable.Pages.Asientos.CreateModel
@{
    ViewData["Title"] = "Nuevo Asiento";
}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-file-invoice-dollar text-primary"></i> Nuevo Asiento
    </h1>
    <a asp-page="Index" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
        <i class="fas fa-arrow-left fa-sm text-white-50"></i> Atrás
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Datos del Asiento</h6>
    </div>
    <div class="card-body">

        <form method="post">
            @Html.AntiForgeryToken()

            <!-- DATOS GENERALES -->
            <div class="form-row mb-3">
                <div class="form-group col-md-3">
                    <label class="font-weight-bold">Fecha</label>
                    <input asp-for="Asiento.FechaAsiento" type="date" class="form-control" />
                    <span asp-validation-for="Asiento.FechaAsiento" class="text-danger"></span>
                </div>

                <div class="form-group col-md-3">
                    <label class="font-weight-bold">Código</label>
                    <input asp-for="Asiento.Codigo" class="form-control" />
                    <span asp-validation-for="Asiento.Codigo" class="text-danger"></span>
                </div>

                <div class="form-group col-md-6">
                    <label class="font-weight-bold">Referencia</label>
                    <input asp-for="Asiento.Referencia" class="form-control" />
                    <span asp-validation-for="Asiento.Referencia" class="text-danger"></span>
                </div>
            </div>

            <hr />

            <!-- DETALLE -->
            <h6 class="font-weight-bold text-primary mb-2">
                <i class="fas fa-list"></i> Detalle del Asiento
            </h6>

            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm align-middle" id="detalle-table">
                    <thead class="thead-light">
                        <tr>
                            <th style="width:30%;">Cuenta</th>
                            <th style="width:15%;">Movimiento</th>
                            <th style="width:15%;">Monto</th>
                            <th>Descripción</th>
                            <th style="width:90px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="detalle-row">
                            <td>
                                <select name="Detalles[0].CuentaId" class="form-control form-control-sm">
                                    <option value="">-- Seleccione --</option>
                                    @foreach (var c in Model.Cuentas)
                                    {
                                        <option value="@c.Value">@c.Text</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <select name="Detalles[0].TipoMovimiento" class="form-control form-control-sm">
                                    <option value="deudor">Deudor</option>
                                    <option value="acreedor">Acreedor</option>
                                </select>
                            </td>
                            <td>
                                <input name="Detalles[0].Monto" class="form-control form-control-sm" />
                            </td>
                            <td>
                                <input name="Detalles[0].Descripcion" class="form-control form-control-sm" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-danger btn-remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" id="btn-add-line" class="btn btn-sm btn-outline-secondary mb-3">
                <i class="fas fa-plus"></i> Agregar línea
            </button>

            <!-- TOTALES -->
            <div class="border rounded p-3 mb-3 bg-light">
                <div class="row">
                    <div class="col-md-3">
                        <label class="font-weight-bold mb-0">Total Débito</label>
                        <div class="fw-bold" id="total-debito">0.00</div>
                    </div>
                    <div class="col-md-3">
                        <label class="font-weight-bold mb-0">Total Crédito</label>
                        <div class="fw-bold" id="total-credito">0.00</div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <span id="balance-indicator" class="badge bg-secondary">No balanceado</span>
                    </div>
                </div>
            </div>

            <!-- ACCIONES -->
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar
            </button>
            <a asp-page="Index" class="btn btn-secondary">
                Cancelar
            </a>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const table = document.querySelector('#detalle-table tbody');
            const addBtn = document.getElementById('btn-add-line');

            function reindex() {
                const rows = table.querySelectorAll('.detalle-row');
                rows.forEach((row, i) => {
                    row.querySelectorAll('input, select').forEach(el => {
                        el.name = el.name.replace(/\[\d+\]/, '[' + i + ']');
                    });
                });
            }

            function recalcTotals() {
                let debito = 0, credito = 0;

                table.querySelectorAll('.detalle-row').forEach(r => {
                    const tipo = r.querySelector('select[name$=".TipoMovimiento"]').value;
                    const monto = parseFloat(r.querySelector('input[name$=".Monto"]').value) || 0;

                    if (tipo === 'deudor') debito += monto;
                    if (tipo === 'acreedor') credito += monto;
                });

                document.getElementById('total-debito').textContent = debito.toFixed(2);
                document.getElementById('total-credito').textContent = credito.toFixed(2);

                const badge = document.getElementById('balance-indicator');
                if (debito === credito && debito > 0) {
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Balanceado';
                } else {
                    badge.className = 'badge bg-danger';
                    badge.textContent = 'No balanceado';
                }
            }

            addBtn.addEventListener('click', () => {
                const firstRow = table.querySelector('.detalle-row');
                const clone = firstRow.cloneNode(true);

                clone.querySelectorAll('input').forEach(i => i.value = '');
                clone.querySelectorAll('select').forEach(s => s.selectedIndex = 0);

                table.appendChild(clone);
                reindex();
            });

            table.addEventListener('click', e => {
                if (e.target.closest('.btn-remove')) {
                    e.target.closest('tr').remove();
                    reindex();
                    recalcTotals();
                }
            });

            table.addEventListener('input', recalcTotals);
        })();
    </script>
}
